import pickle
from symreg.formula import *
from typing import List


def load(filename: str, max_count: int | None = None, offset: int = 0) -> List[Formula]:
    """
    Load formulas from a file that was generated by `generate_database.py`.
    Such file must have the extension `.pkl.xz` or `.pkl`.

    Parameters
    ----------
    filename : str
        The filename to load from.
    max_count : int, optional
        The maximum number of formulas to load. If None, all formulas are loaded.
    offset : int, optional
        The offset to start loading formulas from.

    Returns
    -------
    List[Formula]
        The formulas loaded from the file.
    """

    formulas = []

    # Select the appropriate open function based on the file extension
    if filename.endswith(".xz"):
        from lzma import open as lzma_open

        open_func = lzma_open
    elif filename.endswith(".gz"):
        from gzip import open as gzip_open

        open_func = gzip_open
    elif filename.endswith(".bz2"):
        from bz2 import open as bz2_open

        open_func = bz2_open
    else:
        open_func = open

    # Load formulas from the file
    with open_func(filename, "rb") as f:
        while True:
            try:
                formulas_bucket = pickle.load(f)
                if offset >= len(formulas_bucket):
                    offset -= len(formulas_bucket)
                    continue
                elif offset > 0:
                    formulas_bucket = formulas_bucket[offset:]
                    offset = 0

                formulas += formulas_bucket

                if max_count is not None and len(formulas) >= max_count:
                    formulas = formulas[:max_count]
                    break
            except EOFError:
                break

    return formulas
